<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Share Profile - OpenInterview.me</title>
  <link rel="stylesheet" href="/css/tailwind.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .toast { animation: slideUp .2s ease-out; }
    @keyframes slideUp { from { transform: translateY(6px); opacity:0 } to { transform: translateY(0); opacity:1 } }
  </style>
</head>
<body class="bg-[#f7f7f7] dark:bg-[#191919] text-[#141414] dark:text-neutral-50">
  <div id="toastRoot" class="fixed inset-x-0 top-4 z-[9999] flex justify-center px-4"></div>
  <div class="relative flex min-h-screen w-full items-center justify-center bg-gray-200/50 p-4">
    <div class="bg-white dark:bg-[#191919] shadow-xl rounded-xl w-full max-w-lg">
      <div class="relative p-8">
        <button id="btnClose" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300" aria-label="Close share window">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
        <div class="flex flex-col gap-8">
          <div>
            <p class="text-3xl font-black leading-tight tracking-tighter">Share Profile</p>
            <p id="profileHint" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
          </div>
          <div class="flex flex-col gap-4">
            <label class="flex flex-col">
              <p class="text-sm font-medium pb-2">Email <span class="text-red-500">*</span></p>
              <input id="emailInput" type="email" autocomplete="email"
                class="form-input flex w/full overflow-hidden rounded-lg focus:outline-0 focus:ring-2 focus:ring-black/50 border border-gray-300 dark:border-gray-700 bg-[#f7f7f7] dark:bg-gray-800 h-12 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-4 text-base"
                placeholder="Enter recipient email" value="" data-testid="input-email"/>
              <span id="emailError" class="hidden mt-2 text-sm text-red-600">Please enter a valid email address.</span>
            </label>
            <label class="flex flex-col">
              <p class="text-sm font-medium pb-2">Message</p>
              <textarea id="messageInput"
                class="form-input flex w-full overflow-hidden rounded-lg focus:outline-0 focus:ring-2 focus:ring-black/50 border border-gray-300 dark:border-gray-700 bg-[#f7f7f7] dark:bg-gray-800 min-h-32 placeholder:text-gray-400 dark:placeholder:text-gray-500 p-4 text-base"
                placeholder="Add a personal message (optional)" data-testid="input-message"></textarea>
            </label>
            <div class="flex flex-col gap-2">
              <p class="text-xs text-gray-500 dark:text-gray-400">Share link</p>
              <div class="flex items-stretch gap-2">
                <input id="linkOutput" readonly
                  class="flex-1 h-12 px-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm text-gray-700 dark:text-gray-200"
                  value="" data-testid="input-link"/>
                <button id="btnCopyLink"
                  class="shrink-0 px-4 h-12 rounded-lg bg-gray-100 dark:bg-gray-800 text-black dark:text-neutral-50 text-sm font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-testid="button-copy-link">
                  Copy Link
                </button>
              </div>
              <p class="text-xs text-gray-400 dark:text-gray-500">Note: an email must be provided to share this link.</p>
            </div>
          </div>
          <div>
            <button id="btnSendInvite"
              class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-[#141414] text-white text-base font-bold leading-normal tracking-wide hover:bg-black/90 transition-colors" data-testid="button-send-invite">
              <span class="truncate">Send Invite</span>
            </button>
          </div>
          <div class="flex items-center gap-4">
            <hr class="flex-grow border-t border-gray-200 dark:border-gray-700"/>
            <span class="text-xs text-gray-400 dark:text-gray-500">OR</span>
            <hr class="flex-grow border-t border-gray-200 dark:border-gray-700"/>
          </div>
          <div>
            <button id="btnCopyOnly"
              class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-gray-100 dark:bg-gray-800 text-black dark:text-neutral-50 text-base font-bold leading-normal tracking-wide hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-testid="button-copy-only">
              <span class="truncate">Copy Link (requires email)</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
<script type="module">
import { toast, ensureStyles } from './js/utils.js';
import { buildEmail } from './js/email_template.js';
import { sendEmail } from './js/mailer.mock.js';
ensureStyles();
const qs = new URLSearchParams(location.search);
const profileId = qs.get('profileId') || '';
const slug = qs.get('slug') || '';
const explicitUrl = qs.get('url') ? decodeURIComponent(qs.get('url')) : '';

function sanitizeUrl(url) {
  if (!url) return null;
  try {
    const parsed = new URL(url, location.origin);
    // Only allow http(s) protocols on same origin
    if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return null;
    if (parsed.origin !== location.origin) return null;
    
    // Reject URLs with dangerous characters (quotes, brackets, parentheses, etc.)
    const dangerousChars = /[<>"'`(){}]/;
    if (dangerousChars.test(parsed.href)) return null;
    
    return parsed.href;
  } catch {
    return null;
  }
}

function buildShareUrl() {
  const base = location.origin || "";
  if (explicitUrl) {
    const sanitized = sanitizeUrl(explicitUrl);
    if (sanitized) return sanitized;
    // If explicit URL is malicious, fall through to default
  }
  if (slug)      return `${base}/index.html?u=${encodeURIComponent(slug)}`;
  if (profileId) return `${base}/index.html?profileId=${encodeURIComponent(profileId)}`;
  return `${base}/index.html`;
}
const emailInput   = document.getElementById('emailInput');
const messageInput = document.getElementById('messageInput');
const linkOutput   = document.getElementById('linkOutput');
const emailError   = document.getElementById('emailError');
const btnSend      = document.getElementById('btnSendInvite');
const btnCopyLink  = document.getElementById('btnCopyLink');
const btnCopyOnly  = document.getElementById('btnCopyOnly');
const btnClose     = document.getElementById('btnClose');
const profileHint  = document.getElementById('profileHint');
const shareUrl = buildShareUrl();
linkOutput.value = shareUrl;
if (slug)      profileHint.textContent = `Sharing profile: ${slug}`;
else if (profileId) profileHint.textContent = `Sharing profile #${profileId}`;
function validEmail(v) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||'').trim()); }
function requireEmail() {
  const ok = validEmail(emailInput.value);
  emailError.classList.toggle('hidden', ok);
  return ok;
}
async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast('Link copied to clipboard.', 'success');
  } catch {
    try {
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); ta.remove();
      toast('Link copied.', 'success');
    } catch {}
  }
}
function persistAccessEmail(profileIdOrSlug, email, message) {
  const key = profileIdOrSlug ? `oi.access.${profileIdOrSlug}` : 'oi.access.__generic__';
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  const exists = list.some(e => (e && e.email || '').toLowerCase() === email.toLowerCase());
  if (!exists) {
    list.push({ email, message: message || '', addedAt: new Date().toISOString(), source: 'share' });
    localStorage.setItem(key, JSON.stringify(list));
  }
}
async function trySendInvite() {
  if (!requireEmail()) { emailInput.focus(); return; }
  const email = emailInput.value.trim();
  const message = messageInput.value.trim();
  persistAccessEmail(profileId || slug, email, message);
  const senderName = localStorage.getItem('oi.me.name') || 'OpenInterview User';
  const { subject, html } = buildEmail({ senderName, message, link: shareUrl });
  await sendEmail({ to: email, subject, html });
  try {
    if (window.opener && window.opener.postMessage) {
      window.opener.postMessage(
        { type: 'share:sent', email, profileKey: (profileId || slug || '__generic__') },
        location.origin
      );
    }
  } catch {}
  toast('Invite sent.', 'success');
  setTimeout(() => { window.close?.(); }, 800);
}
btnSend.addEventListener('click', trySendInvite);
btnCopyLink.addEventListener('click', async () => { await copyToClipboard(linkOutput.value); });
btnCopyOnly.addEventListener('click', async () => {
  if (!requireEmail()) { toast('Add a valid email first to share the link.', 'error'); emailInput.focus(); return; }
  await copyToClipboard(linkOutput.value);
  persistAccessEmail(profileId || slug, emailInput.value.trim(), messageInput.value.trim());
});
emailInput.addEventListener('input', requireEmail);
btnClose.addEventListener('click', () => {
  if (window.opener) { try { window.close(); } catch {} }
  else { history.length > 1 ? history.back() : (location.href = '/home.html'); }
});
window.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); trySendInvite(); }
});
</script>
</body>
</html>
