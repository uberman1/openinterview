
# Auth & Session v0.1.1 — Same-Origin Patch (Replit)

## What this fixes
- Headless tests failing because the binder posted to `127.0.0.1` while the page ran on `localhost` (different origins).
- Adds robust wait for `/api/auth/signup` response before asserting UI change.

## Files in this patch
- `public/auth.bind.js` — uses SAME ORIGIN by default (or `localStorage.qa_api_base`).
- `public/auth_test.html.patch` — CSP `connect-src 'self'` only.
- `auth_pack/tests.py` — same-origin base + `expect_response` wait; version bumped to `v0.1.1`.
- `scripts/patch_backend_cors.sh` — idempotent CORS safety net in `backend/main.py`.

## How to apply (copy/paste)
```bash
# 1) Upload and unzip into repo root
unzip -o auth_session_patch_v0_1_1.zip

# 2) Apply CORS safety net (ok if already present)
bash scripts/patch_backend_cors.sh

# 3) Patch the CSP line (three-way friendly). If patch fails, open the file and update the CSP meta manually.
git apply --reject --whitespace=fix public/auth_test.html.patch || true

# 4) Restart your API
bash scripts/serve_api.sh

# 5) Re-run tests
pip install -r auth_pack/requirements.txt
python -m playwright install chromium
PYTHONPATH=. python auth_pack/run.py
```

If you serve files on a different port, set:
```js
localStorage.setItem('qa_api_base', 'http://YOUR_HOST:PORT');
```
before loading `/public/auth_test.html`.
