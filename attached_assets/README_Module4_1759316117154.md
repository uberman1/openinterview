# Module 4 — Real Auth Adapter (In-Memory Persistence) + Selftests

Objective
- Replace mock-only auth with a basic persistent auth adapter (in-memory).
- Keep feature flag: USE_MOCK_AUTH=true falls back to mock; otherwise use real adapter.
- Extend selftests for signup → login → me and protected routes.
- Preserve Node 20 compatibility and module-aware logs.

What's included
- /server/auth.real.js — real auth adapter with in-memory user & token stores
- /server/auth.routes.js — unified auth routes that switch between real or mock based on USE_MOCK_AUTH
- /server/server.js (patch file: server.server.patch.js) — mounts unified auth routes
- /scripts/selftest.js (patch file: scripts.selftest.m04.js) — adds Module 04 checks; writes logs/mod-04.log
- README_Module4.md — this file
- DIFFS.md — exact steps to replace/patch the files

Apply
1) Add files:
   - Copy /server/auth.real.js
   - Copy /server/auth.routes.js
2) Replace files (rename as instructed):
   - server.server.patch.js → /server/server.js
   - scripts.selftest.m04.js → /scripts/selftest.js
3) Build and run Module 04 test:
   ```bash
   npm run build
   MODULE_NUM=04 node scripts/selftest.js
   ```

Environment / Flags
- To use real adapter (default): do nothing (or set USE_MOCK_AUTH="" or "false")
- To force mock adapter: set USE_MOCK_AUTH=true

Exit criteria
- POST /api/v1/auth/signup (201) creates a user
- POST /api/v1/auth/login (200) authenticates and returns token
- GET /api/v1/auth/me (200) returns user when token provided
- GET /api/v1/protected/ping (401 unauth, 200 auth)
- Client build passes
- Selftests write logs/selftest.mod-04.json and logs/mod-04.log and print ALL CHECKS PASSED
